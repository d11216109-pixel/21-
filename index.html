<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>10點半 | Ten and a Half</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.09);
      --text: #e8eefc;
      --muted: rgba(232,238,252,0.75);
      --accent: #66e3ff;
      --good: #6dff9f;
      --bad: #ff6d7a;
      --warn: #ffd166;
      --shadow: 0 14px 40px rgba(0,0,0,0.45);
      --radius: 18px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color: var(--text);
      min-height: 100vh;
      display: grid;
      place-items: center;
      background:
        radial-gradient(1000px 600px at 20% 10%, rgba(102,227,255,0.18), transparent 55%),
        radial-gradient(900px 500px at 80% 0%, rgba(109,255,159,0.12), transparent 60%),
        radial-gradient(1000px 700px at 50% 100%, rgba(255,109,122,0.10), transparent 60%),
        linear-gradient(180deg, #0b1220, #070b14 70%);
      padding: 24px;
    }

    .app {
      width: min(980px, 100%);
      display: grid;
      gap: 18px;
    }

    header {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 12px;
    }

    header h1 {
      margin: 0;
      font-weight: 800;
      letter-spacing: 0.5px;
      font-size: clamp(26px, 3.2vw, 40px);
    }

    header .sub {
      color: var(--muted);
      margin-top: 6px;
      font-size: 14px;
    }

    .board {
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 0;
    }

    @media (max-width: 860px) {
      .grid { grid-template-columns: 1fr; }
    }

    .left, .right {
      padding: 18px;
    }

    .left {
      border-right: 1px solid rgba(255,255,255,0.08);
    }

    @media (max-width: 860px) {
      .left { border-right: none; border-bottom: 1px solid rgba(255,255,255,0.08); }
    }

    .panel {
      background: var(--panel2);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      padding: 14px;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }

    .label {
      font-size: 13px;
      color: var(--muted);
      letter-spacing: 0.3px;
    }

    .value {
      font-size: 20px;
      font-weight: 750;
    }

    .chips {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 10px;
      margin-top: 12px;
    }

    .chip {
      user-select: none;
      cursor: pointer;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      transition: transform 0.08s ease, background 0.2s ease, border-color 0.2s ease;
      font-weight: 700;
      text-align: center;
    }

    .chip:hover {
      transform: translateY(-1px);
      border-color: rgba(102,227,255,0.55);
      background: rgba(102,227,255,0.12);
    }

    .chip:active { transform: translateY(0px); }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
    }

    button {
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 750;
      transition: background 0.2s ease, transform 0.08s ease, border-color 0.2s ease, opacity 0.2s ease;
    }

    button:hover {
      border-color: rgba(102,227,255,0.55);
      background: rgba(102,227,255,0.12);
    }

    button:active { transform: translateY(1px); }

    button.primary {
      background: linear-gradient(135deg, rgba(102,227,255,0.22), rgba(109,255,159,0.16));
      border-color: rgba(102,227,255,0.65);
    }

    button.primary:hover {
      background: linear-gradient(135deg, rgba(102,227,255,0.32), rgba(109,255,159,0.22));
    }

    button.danger {
      border-color: rgba(255,109,122,0.55);
    }

    button.danger:hover {
      background: rgba(255,109,122,0.12);
      border-color: rgba(255,109,122,0.75);
    }

    button:disabled {
      opacity: 0.42;
      cursor: not-allowed;
    }

    .cards {
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }

    .hand {
      display: grid;
      gap: 8px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
    }

    .hand-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .hand-title {
      font-weight: 800;
      letter-spacing: 0.3px;
    }

    .hand-sub {
      color: var(--muted);
      font-size: 13px;
    }

    .pills {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .pill {
      border: 1px solid rgba(255,255,255,0.14);
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,0.18);
      font-size: 13px;
      color: var(--muted);
    }

    .status {
      margin-top: 14px;
      padding: 14px;
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.18);
      min-height: 64px;
      display: grid;
      gap: 8px;
    }

    .status strong { letter-spacing: 0.2px; }

    .status .msg {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.35;
    }

    .good { color: var(--good); }
    .bad { color: var(--bad); }
    .warn { color: var(--warn); }

    footer {
      color: rgba(232,238,252,0.65);
      font-size: 12px;
      text-align: center;
      margin-top: 8px;
    }

    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 3px 6px;
      border: 1px solid rgba(255,255,255,0.20);
      border-bottom-width: 2px;
      border-radius: 8px;
      background: rgba(0,0,0,0.22);
      color: rgba(232,238,252,0.85);
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>10點半（Ten and a Half）</h1>
        <div class="sub">新局 → 玩家/莊家抽牌 → 結算 → 再來一局</div>
      </div>
      <div class="pills" aria-label="快捷鍵提示">
        <div class="pill"><span class="kbd">Enter</span> 新局</div>
        <div class="pill"><span class="kbd">H</span> 要牌</div>
        <div class="pill"><span class="kbd">S</span> 停牌</div>
      </div>
    </header>

    <div class="board">
      <div class="grid">
        <section class="left">
          <div class="panel">
            <div style="padding: 10px 0;">
              <div class="label" style="margin-bottom: 8px;">遊戲規則</div>
              <div style="font-size: 13px; line-height: 1.6; color: var(--muted);">
                • 目標：點數接近 10.5 但不超過<br>
                • 點數：A=1、2~10=牌面、J/Q/K=0.5<br>
                • 超過 10.5 立即爆牌<br>
                • 莊家到達 9.0 時停牌<br>
                • 牌庫剩餘：<span id="deckCount">52</span> 張
              </div>
            </div>

            <div class="controls" aria-label="遊戲操作" style="margin-top: 14px;">
              <button class="primary" id="dealBtn" aria-label="新局">新局</button>
              <button id="hitBtn" aria-label="要牌" disabled>要牌（H）</button>
              <button id="standBtn" aria-label="停牌" disabled>停牌（S）</button>
            </div>
          </div>

          <div class="status" role="status" aria-live="polite" aria-label="狀態訊息">
            <strong id="statusTitle">準備下注</strong>
            <div class="msg" id="statusMsg">選擇籌碼來下注，然後按「發牌」。</div>
          </div>

          <footer>
            提示：要牌/停牌可用鍵盤快捷鍵（<span class="kbd">H</span>/<span class="kbd">S</span>）。
            <span aria-hidden="true">•</span>
            單機離線遊戲，無需網路連線。
          </footer>
        </section>

        <section class="right">
          <div class="cards" aria-label="牌局">
            <div class="hand" aria-label="玩家手牌">
              <div class="hand-header">
                <div>
                  <div class="hand-title">玩家</div>
                  <div class="hand-sub" id="playerScore">點數：0</div>
                </div>
                <div class="pills" id="playerBadges" aria-label="玩家狀態"></div>
              </div>
              <div id="playerCards" aria-label="玩家牌面"></div>
            </div>

            <div class="hand" aria-label="莊家手牌">
              <div class="hand-header">
                <div>
                  <div class="hand-title">莊家</div>
                  <div class="hand-sub" id="dealerScore">點數：0</div>
                </div>
                <div class="pills" id="dealerBadges" aria-label="莊家狀態"></div>
              </div>
              <div id="dealerCards" aria-label="莊家牌面"></div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    // ---- Game Constants ----
    const TARGET = 10.5;
    const DEALER_STAND_AT = 9.0;
    const INITIAL_CARDS = 1;

    // ---- DOM Elements ----
    const statusTitleEl = document.getElementById('statusTitle');
    const statusMsgEl = document.getElementById('statusMsg');
    const deckCountEl = document.getElementById('deckCount');

    const dealBtn = document.getElementById('dealBtn');
    const hitBtn = document.getElementById('hitBtn');
    const standBtn = document.getElementById('standBtn');

    const playerCardsEl = document.getElementById('playerCards');
    const dealerCardsEl = document.getElementById('dealerCards');
    const playerScoreEl = document.getElementById('playerScore');
    const dealerScoreEl = document.getElementById('dealerScore');
    const playerBadgesEl = document.getElementById('playerBadges');
    const dealerBadgesEl = document.getElementById('dealerBadges');

    // ---- Game State ----
    let deck = [];
    let player = [];
    let dealer = [];
    let phase = 'IDLE'; // IDLE, PLAYER_TURN, DEALER_TURN, SETTLED

    function setStatus(title, msg, cls = '') {
      statusTitleEl.className = cls;
      statusTitleEl.textContent = title;
      statusMsgEl.textContent = msg;
    }

    function updateDeckCount() {
      deckCountEl.textContent = deck.length;
    }

    function newDeck() {
      const suits = ['♠', '♥', '♦', '♣'];
      const ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
      const d = [];
      for (const s of suits) {
        for (const r of ranks) d.push({ r, s });
      }
      // Shuffle using Fisher-Yates with crypto.getRandomValues if available
      if (window.crypto && window.crypto.getRandomValues) {
        const arr = new Uint32Array(d.length);
        window.crypto.getRandomValues(arr);
        for (let i = d.length - 1; i > 0; i--) {
          const j = arr[i] % (i + 1);
          [d[i], d[j]] = [d[j], d[i]];
        }
      } else {
        // Fallback to Math.random
        console.warn('crypto.getRandomValues not available, using Math.random');
        for (let i = d.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [d[i], d[j]] = [d[j], d[i]];
        }
      }
      return d;
    }

    function cardValue(card) {
      if (card.r === 'A') return 1;
      if (['K','Q','J'].includes(card.r)) return 0.5;
      return Number(card.r);
    }

    function score(hand) {
      let total = 0;
      for (const c of hand) {
        total += cardValue(c);
      }
      return total;
    }

    function isBust(hand) {
      return score(hand) > TARGET;
    }

    function renderHand(el, hand) {
      el.innerHTML = '';
      if (hand.length === 0) {
        el.innerHTML = '<div style="color: var(--muted); font-size: 13px;">尚未發牌</div>';
        return;
      }
      hand.forEach((c, idx) => {
        const div = document.createElement('div');
        div.style.display = 'inline-grid';
        div.style.placeItems = 'center';
        div.style.width = '54px';
        div.style.height = '74px';
        div.style.marginRight = '8px';
        div.style.borderRadius = '14px';
        div.style.border = '1px solid rgba(255,255,255,0.18)';
        div.style.background = 'rgba(0,0,0,0.25)';
        div.style.boxShadow = '0 10px 20px rgba(0,0,0,0.25)';
        div.style.fontWeight = '800';
        div.style.letterSpacing = '0.5px';
        div.style.userSelect = 'none';

        div.textContent = `${c.r}${c.s}`;
        div.setAttribute('aria-label', `牌 ${c.r}${c.s}`);
        if (c.s === '♥' || c.s === '♦') div.style.color = '#ff8a98';
        el.appendChild(div);
      });
    }

    function badge(container, text, cls = '') {
      const b = document.createElement('div');
      b.className = 'pill ' + cls;
      b.textContent = text;
      container.appendChild(b);
    }

    function clearBadges() {
      playerBadgesEl.innerHTML = '';
      dealerBadgesEl.innerHTML = '';
    }

    function syncUI() {
      renderHand(playerCardsEl, player);
      renderHand(dealerCardsEl, dealer);

      const pScore = player.length > 0 ? score(player) : 0;
      const dScore = dealer.length > 0 ? score(dealer) : 0;

      playerScoreEl.textContent = `點數：${pScore.toFixed(1)}`;
      dealerScoreEl.textContent = `點數：${dScore.toFixed(1)}`;

      updateDeckCount();

      // Button states based on phase
      dealBtn.disabled = (phase !== 'IDLE' && phase !== 'SETTLED');
      hitBtn.disabled = (phase !== 'PLAYER_TURN');
      standBtn.disabled = (phase !== 'PLAYER_TURN');
    }

    function startRound() {
      if (phase !== 'IDLE' && phase !== 'SETTLED') return;

      // Create and shuffle new deck
      deck = newDeck();
      
      // Check for deck rebuild if needed (edge case)
      if (deck.length < 10) {
        setStatus('牌庫重建', '牌庫不足，已重新建立並洗牌。', 'warn');
        deck = newDeck();
      }

      player = [];
      dealer = [];
      clearBadges();

      // Deal initial cards (1 each as per spec)
      for (let i = 0; i < INITIAL_CARDS; i++) {
        player.push(deck.pop());
        dealer.push(deck.pop());
      }

      phase = 'PLAYER_TURN';
      setStatus('玩家回合', '要牌（Hit）或停牌（Stand）？', '');
      syncUI();
    }

    function hit() {
      if (phase !== 'PLAYER_TURN') return;
      
      player.push(deck.pop());
      syncUI();
      
      const p = score(player);
      if (isBust(player)) {
        badge(playerBadgesEl, '爆牌', 'bad');
        setStatus('玩家爆牌', `點數 ${p.toFixed(1)} 超過 ${TARGET}`, 'bad');
        settle();
        return;
      }
      
      setStatus('玩家回合', `目前點數：${p.toFixed(1)}。繼續要牌或停牌？`, '');
    }

    function stand() {
      if (phase !== 'PLAYER_TURN') return;
      
      phase = 'DEALER_TURN';
      setStatus('莊家回合', '莊家自動補牌中...', '');
      syncUI();

      // Dealer draws until >= DEALER_STAND_AT or bust
      setTimeout(() => {
        while (score(dealer) < DEALER_STAND_AT && !isBust(dealer)) {
          dealer.push(deck.pop());
        }
        
        if (isBust(dealer)) {
          badge(dealerBadgesEl, '爆牌', 'bad');
        }
        
        syncUI();
        settle();
      }, 500);
    }

    function settle() {
      const p = score(player);
      const d = score(dealer);
      const pBust = isBust(player);
      const dBust = isBust(dealer);

      phase = 'SETTLED';

      let title = '';
      let msg = '';
      let cls = '';

      // Settlement rules as per spec
      if (pBust) {
        title = '玩家輸';
        msg = `玩家爆牌（${p.toFixed(1)} > ${TARGET}），莊家勝。`;
        cls = 'bad';
      } else if (dBust) {
        title = '玩家勝';
        msg = `莊家爆牌（${d.toFixed(1)} > ${TARGET}），玩家勝。`;
        cls = 'good';
      } else {
        if (p > d) {
          title = '玩家勝';
          msg = `玩家點數更高（${p.toFixed(1)} vs ${d.toFixed(1)}）。`;
          cls = 'good';
        } else if (p < d) {
          title = '玩家輸';
          msg = `莊家點數更高（${p.toFixed(1)} vs ${d.toFixed(1)}）。`;
          cls = 'bad';
        } else {
          title = '和局（PUSH）';
          msg = `雙方點數相同（${p.toFixed(1)}）。`;
          cls = 'warn';
        }
      }

      // Add badges for special conditions
      if (p === TARGET) badge(playerBadgesEl, '10.5', 'good');
      if (d === TARGET) badge(dealerBadgesEl, '10.5', 'good');

      setStatus(title, msg + ' 點擊「新局」開始下一局。', cls);
      syncUI();
    }

    // Button event listeners
    dealBtn.addEventListener('click', startRound);
    hitBtn.addEventListener('click', hit);
    standBtn.addEventListener('click', stand);

    // Keyboard shortcuts
    window.addEventListener('keydown', (e) => {
      const key = e.key.toLowerCase();
      if (key === 'enter') {
        if (phase === 'IDLE' || phase === 'SETTLED') startRound();
      } else if (key === 'h') {
        hit();
      } else if (key === 's') {
        stand();
      }
    });

    // Initialize
    setStatus('準備開始', '點擊「新局」開始遊戲。', '');
    player = [];
    dealer = [];
    syncUI();
  </script>
</body>
</html>
